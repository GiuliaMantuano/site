<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<head>
<title>Codurance - Testing legacy code with Golden Master</title>
 <!-- Meta -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">

<!-- Open Graph tags - Used when publishing on Facebook -->
<meta property="og:site_name" content="Codurance"/>
<meta property="og:description" content="We build well-crafted software"/>
<meta property="og:url" content="http://codurance.com"/>
<meta property="og:image" content="http://codurance.com/assets/img/codurance.png"/>

<!-- Favicon -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">

<!-- CSS Global Compulsory -->
<link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/assets/css/style.css">

<!-- CSS Implementing Plugins -->
<link rel="stylesheet" href="/assets/plugins/line-icons/line-icons.css">
<link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/assets/plugins/owl-carousel/owl-carousel/owl.carousel.css">

<!-- CSS Theme -->
<link rel="stylesheet" href="/assets/css/plugins.css">
<link rel="stylesheet" href="/assets/css/app.css">
<link rel="stylesheet" href="/assets/css/theme-colors/orange.css" id="style_color">

<!-- CSS Customization -->
<link rel="stylesheet" href="/assets/css/custom.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/idea.min.css">
<!--fonts -->
<link href='http://fonts.googleapis.com/css?family=Oxygen:700,400' rel='stylesheet' type='text/css'>



<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46289079-1', 'codurance.com');
    ga('send', 'pageview');
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<div class="wrapper">
<!--=== Header ===-->
<div class="header-v3 header-sticky">
        <!-- Navbar -->
        <div class="navbar navbar-default" role="navigation">
            <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="fa fa-bars"></span>
                    </button>
                    <a class="navbar-brand" href="/">
                        <img id="logo-header" src="/assets/img/codurance.png" height="45px;" alt="Logo">
                    </a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse navbar-responsive-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/services">Services</a></li>
                        <li><a href="/casestudies">Case Studies</a></li>
                        <li><a href="/videos">Videos</a></li>
                        <li><a href="/blog">Blog</a></li>
                        <li><a href="/work-with-us">Work with us</a></li>
                        <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown">About Us <i class="icon-angle-down">&nbsp;</i></a><ul class="dropdown-menu">
                            <li><a href="/aboutus/ourteam">Our Team</a></li>
                            <li><a href="/aboutus/ourcompany">Our Company</a></li>
                            <li><a href="/aboutus/ourpractices">Our Practices</a></li>
                        </ul></li>
                    </ul>
                </div><!--/navbar-collapse-->
            </div>    
        </div>            
        <!-- End Navbar -->
    </div>
    <!--=== End Header ===--> 

<!--=== End Header ===-->


    <div class="breadcrumbs margin-bottom-10">
        <div class="container">
            <h2 class="pull-left">Testing legacy code with Golden Master</h2>
            <ul class="pull-right breadcrumb">
                <li><a href="/">Home</a></li>
                
                    <li>
                    
                        <a href="/blog">Blog</a>
                    
                    </li>
                
            </ul>
        </div>
    </div>



<div class="container">
<div class="row blog-page blog-item">
<!-- Left Sidebar -->
<div class="col-md-9 md-margin-bottom-60">
    <!--Blog Post-->
    <div class="blog margin-bottom-40">
        
        <div class="blog-post-tags">
            <ul class="list-unstyled list-inline blog-info">
                <li><i class="fa fa-calendar"></i> 11 Nov 2012</li>
                <li><i class="fa fa-pencil"></i> Sandro Mancuso</li>
                <li class="blog-share-buttons">
                  <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
                  <script type="IN/Share"></script>

                  <a class="twitter-share-button"
                      href="https://twitter.com/intent/tweet?url=http://www.codurance.com/2012/11/11/testing-legacy-code-with-golden-master/"
                      data-count="none">
                      Tweet</a>
                </li>
            </ul>
        </div>
        

        

        <p>As a warm up for <a href="http://scna.softwarecraftsmanship.org/">SCNA</a>, the
<a href="http://www.meetup.com/ChicagoSC/">Chicago Software Craftsmanship Community</a> ran a hands-on coding
session where developers, working in pairs, should test and refactor
some legacy code. For that they used the <a href="https://github.com/sandromancuso/Gilded-Rose-Kata">Gilded Rose kata</a>. You can find
links to versions in java, C# and ruby
<a href="https://github.com/sandromancuso/Gilded-Rose-Kata">here</a> and for
clojure
<a href="http://blog.8thlight.com/mike-jansen/2012/09/26/welcome-to-the-gilded-rose-in-clojure.html">here</a>.</p>

<p>We ran the same session for the <a href="http://www.meetup.com/london-software-craftsmanship">London Software Craftsmanship Community (LSCC)</a> early this
year and back then I decided to write my tests BDD-style (I used JBehave
for that). You can check my solution
<a href="https://github.com/sandromancuso/Gilded-Rose-Kata">here</a>.</p>

<p>This time, instead of writing unit tests or BDD / Spec By Example to
test every branch of that horrible code, I decided to solve it using a
test style called Golden Master.</p>

<h3>The Golden Master approach</h3>

<p>Before making any change to the production code, do the following:</p>

<ol>
<li>Create X number of random inputs, always using the same random seed,
so you can generate always the same set over and over again. You
will probably want a few thousand random inputs.</li>
<li>Bombard the class or system under test with these random inputs.</li>
<li>Capture the outputs for each individual random input</li>
</ol>


<p>When you run it for the first time, record the outputs in a file (or
database, etc). From then on, you can start changing your code, run the
test and compare the execution output with the original output data you
recorded. If they match, keep refactoring, otherwise, revert back your
change and you should be back to green.</p>

<h3>Approval Tests</h3>

<p>An easy way to do Golden Master testing in Java (also available to C#
and Ruby) is to use <a href="http://approvaltests.sourceforge.net/">Approval Tests</a>. It does all the file
handling for you, storing and comparing it. Here is an example:</p>

<pre><code>package org.craftedsw.gildedrose;

import java.util.ArrayList;
import java.util.List;
import java.util.Random;

import org.approvaltests.Approvals;
import org.junit.Before;
import org.junit.Test;

public class GildedRoseTest {

    private static final int FIXED_SEED = 100;
    private static final int NUMBER_OF_RANDOM_ITEMS = 2000;
    private static final int MINIMUM = -50;
    private static final int MAXIMUN = 101;

    private String[] itemNames = {"+5 Dexterity Vest",
                      "Aged Brie",
                      "Elixir of the Mongoose",
                      "Sulfuras, Hand of Ragnaros",
                      "Backstage passes to a TAFKAL80ETC concert",
                      "Conjured Mana Cake"};

    private Random random = new Random(FIXED_SEED);
    private GildedRose gildedRose;

    @Before
    public void initialise() {
        gildedRose = new GildedRose();
    }

    @Test public void
    should_generate_update_quality_output() throws Exception {
        List&lt;Item&gt; items = generateRandomItems(NUMBER_OF_RANDOM_ITEMS);

        gildedRose.updateQuality(items);

        Approvals.verify(getStringRepresentationFor(items));
    }

    private List&lt;Item&gt; generateRandomItems(int totalNumberOfRandomItems) {
        List&lt;Item&gt; items = new ArrayList&lt;Item&gt;();
        for (int cnt = 0; cnt &lt; totalNumberOfRandomItems; cnt++) {
            items.add(new Item(itemName(), sellIn(), quality()));
        }
        return items;
    }

    private String itemName() {
        return itemNames[0 + random.nextInt(itemNames.length)];
    }

    private int sellIn() {
        return randomNumberBetween(MINIMUM, MAXIMUN);
    }

    private int quality() {
        return randomNumberBetween(MINIMUM, MAXIMUN);
    }

    private int randomNumberBetween(int minimum, int maximum) {
        return minimum + random.nextInt(maximum);
    }

    private String getStringRepresentationFor(List&lt;Item&gt; items) {
        StringBuilder builder = new StringBuilder();
        for (Item item : items) {
            builder.append(item).append("\r");
        }
        return builder.toString();
    }

}
</code></pre>

<p>For those not familiar with the kata, after passing a list of items to
the GildedRose class, it will iterate through them and according to many
different rules, it will change their "sellIn" and "quality"
attributes.</p>

<p>I've made a small change in the Item class, adding a automatically
generated toString() method to it:</p>

<pre><code>public class Item {
    private String name;
    private int sellIn;
    private int quality;

    public Item(String name, int sellIn, int quality) {
        this.setName(name);
        this.setSellIn(sellIn);
        this.setQuality(quality);
    }

        // all getters and setters here

    @Override
    public String toString() {
        return "Item [name=" + name +
                              ", sellIn=" + sellIn +
                              ", quality=" + quality + "]";
    }
}
</code></pre>

<p>The first time the test method is executed, the line:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Approvals</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">getStringRepresentationFor</span><span class="o">(</span><span class="n">items</span><span class="o">));</span></code></pre></div>


<p>will generate a text file, in the same folder where the test class is,
called:
GildedRoseTest.should_generate_update_quality_output.received.txt.
That mean, ..received.txt</p>

<p>ApprovalTests then will display the following message in the console:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">To approve run : mv</span>
<span class="go">/Users/sandromancuso/development/projects/java/gildedrose\_goldemaster/./src/test/java/org/craftedsw/gildedrose/GildedRoseTest.should\_generate\_update\_quality\_output.received.txt</span>
<span class="go">/Users/sandromancuso/development/projects/java/gildedrose\_goldemaster/./src/test/java/org/craftedsw/gildedrose/GildedRoseTest.should\_generate\_update\_quality\_output.approved.txt</span></code></pre></div>


<p>Basically, after inspecting the file, if we are happy, we just need to
change the .received with .approved to approve the output. Once this is
done, every time we run the test, ApprovalTests will compare the output
with the approved file.</p>

<p>Here is an example of how the file looks like:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">Item [name=Aged Brie, sellIn=-23, quality=-44]</span>
<span class="go">Item [name=Elixir of the Mongoose, sellIn=-9, quality=45]</span>
<span class="go">Item [name=Conjured Mana Cake, sellIn=-28, quality=1]</span>
<span class="go">Item [name=Aged Brie, sellIn=10, quality=-2]</span>
<span class="go">Item [name=+5 Dexterity Vest, sellIn=31, quality=5]</span></code></pre></div>


<p>Now you are ready to rip the GildedRose horrible code apart. Just make
sure you run the tests every time you make a change. :)</p>

<h3>Infinitest</h3>

<p>If you are using Eclipse or IntelliJ, you can also use
<a href="http://infinitest.github.com/">Infinitest</a>. It automatically runs your
tests every time you save a production or test class. It is smart enough
to run just the relevant tests and not the entire test suite.  In
Eclipse, it displays a bar at the bottom-left corner that can be red,
green or yellow (in case there are compilation errors and the tests
can't be run).</p>

<p>With this, approach, refactoring legacy code becomes a piece of cake.
You make a change, save it, look at the bar at the bottom of the screen.
If it is green, keep refactoring, if it is red, just hit CTRL-Z and you
are back in the green. Wonderful. :)</p>

<h3>Thanks</h3>

<p>Thanks to <a href="https://twitter.com/roberttaylor426">Robert Taylor</a> and
<a href="https://twitter.com/balopat">Balint Pato</a> for showing me this approach
for the first time in one of the
<a href="http://www.meetup.com/london-software-craftsmanship">LSCC</a> meetings
early this year. It was fun to finally do it myself.</p>


        
    </div>
    <!--End Blog Post-->
</div>
<!-- End Left Sidebar -->

<!-- Right Sidebar -->
<div class="col-md-3 magazine-page">
    <!-- Blog Latest Tweets -->
    <div class="blog-twitter margin-bottom-30">
        <a class="twitter-timeline" href="https://twitter.com/mashooq/codurance" data-widget-id="400789734676385792">Tweets from Codurance team</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<script>window.twttr = (function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0],t = window.twttr || {};if (d.getElementById(id)) return t;js = d.createElement(s);js.id = id;js.src = "https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, "script", "twitter-wjs"));</script>
    </div>
    <!-- End Blog Latest Tweets -->
</div>
<!-- End Right Sidebar -->
</div>
<!--/row-->
</div>
<!--/container-->


<!--=== Copyright ===-->
<div class="footer-default">
    <div class="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <p class="copyright-space">
                         Company Registration No: 8712584
                         | Contact us: <a href="mailto:hello@codurance.com" class="">hello@codurance.com</a>
                         | Phone: +44 203 440 4015
                    </p>

                </div>
                <div class="col-md-4">
                    <ul class="social-icons pull-right">
                        <li><a href="/atom.xml" data-original-title="Feed" class="social_rss"></a></li>
                        <li><a href="http://twitter.com/codurance" data-original-title="Twitter" class="social_twitter"></a></li>
                    </ul>
                </div>
            </div> <!--/row-->
        </div> <!--/container-->
    </div><!--/copyright-->
</div>

<!--=== End Copyright ===-->
</div>

<!-- JS Global Compulsory -->
<script type="text/javascript" src="/assets/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/assets/plugins/jquery/jquery-migrate.min.js"></script>
<script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/plugins/back-to-top.js"></script>
<!-- JS Implementing Plugins -->
<script type="text/javascript" src="/assets/plugins/owl-carousel/owl-carousel/owl.carousel.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="/assets/plugins/gmap/gmap.js"></script>
<!-- JS Customization -->
<script type="text/javascript" src="/assets/js/custom.js"></script>
<!-- JS Page Level -->
<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/js/pages/index.js"></script>

<script type="text/javascript">
    jQuery(document).ready(function() {
        App.init();
        Index.initOwlCarousel();
        Contact.initMap();
    });
</script>
<!--[if lt IE 9]>
    <script src="/assets/plugins/respond.js"></script>
    <script src="/assets/plugins/html5shiv.js"></script> 
    <script src="/assets/js/plugins/placeholder-IE-fixes.js"></script>   
<![endif]-->

</body>
</html>
